name: Get-USNS
on:
  workflow_dispatch: {}
  schedule:
    - cron: '*/5 * * * *'

jobs:
  get-usns:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: USN Monitor
      uses: paketo-buildpacks/stack-usns/actions/usn-monitor@main
      with:
        usn_list_path: "usns"

    - name: Commit USNS
      id: commit
      run: |
        if ! git diff --quiet usns; then
          git config user.name "Core Deps"
          git config user.email coredependencies@vmware.com
          git add usns
          git commit -m 'Add new USNs'
          git push

          echo ::set-output name=UPDATED::true
        fi

    - name: Trigger Release
      if: steps.commit.outputs.UPDATED
      uses: paketo-buildpacks/github-config/actions/dispatch@main
      with:
        repos: > 
          paketo-buildpacks/tiny-release,
          paketo-buildpacks/base-release,
          paketo-buildpacks/full-release 
        token: ${{ secrets.CORE_DEPS_CI_BOT_GITHUB_TOKEN }}
        event: new-usn
        payload: '{}'
